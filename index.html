<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dynamic M3U Generator</title>
</head>
<body>
    <p>请输入部署设备的 IP 地址，会自动生成 M3U 文件：</p>
    <input type="text" id="ipInput" placeholder="例如: 192.168.1.2">
    <button onclick="submitIp()">提交</button>
    <p>请将以下内容复制到播放器，或下载 M3U 文件：</p>
    <button onclick="copyToClipboard()">全部复制</button>
    <a id="downloadLink" style="display: none;" download="playlist.m3u">
        <button>下载 M3U 文件</button>
    </a>
    <pre id="result">生成中，请稍候...</pre>
    <script>
        // 从 CDN 获取 M3U 文件的 URL
        const githubRawUrl = 'https://gcore.jsdelivr.net/gh/sln654360/bptv/fy192.168.1.2.m3u';

        // 获取 URL 参数中的 IP，默认值为 192.168.1.2
        const urlParams = new URLSearchParams(window.location.search);
        const ip = urlParams.get('ip') || '192.168.1.2';

        // 设置输入框的值为 URL 参数中的 IP 或默认值
        document.getElementById('ipInput').value = ip;

        // 从 CDN 加载 M3U 文件并替换 IP
        fetch(githubRawUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('无法加载 M3U 文件');
                }
                return response.text(); // 读取纯文本内容，而不是 JSON
            })
            .then(data => {
                // 假设原始 M3U 文件中的 IP 是 192.168.1.2，将其替换为用户输入的 IP
                const result = data.replace(/192\.168\.1\.2/g, ip);
                document.getElementById('result').textContent = result;
                document.querySelector('pre').setAttribute('style', 'white-space: pre-wrap;');

                // 生成下载链接
                const blob = new Blob([result], { type: 'audio/x-mpegurl' });
                const url = URL.createObjectURL(blob);
                const downloadLink = document.getElementById('downloadLink');
                downloadLink.href = url;
                downloadLink.style.display = 'inline';
            })
            .catch(err => {
                console.error('加载失败: ', err);
                document.getElementById('result').textContent = '加载 M3U 文件失败，请检查 URL 或网络连接。';
            });

        // 复制功能
        function copyToClipboard() {
            const text = document.getElementById('result').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('已复制到剪贴板！');
            }).catch(err => {
                console.error('复制失败: ', err);
            });
        }

        // 提交 IP 并跳转
        function submitIp() {
            const ipInput = document.getElementById('ipInput').value.trim();
            if (ipInput) {
                window.location.href = `${window.location.pathname}?ip=${encodeURIComponent(ipInput)}`;
            } else {
                alert('请输入有效的 IP 地址！');
            }
        }
    </script>
</body>
</html>
